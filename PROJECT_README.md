# AI Space - 智能 AI 服务导航与监控平台

## 1. 项目简介
**AI Space** 是一个基于 **Cloudflare 生态** 构建的高性能、服务端渲染 (SSR) 的 AI 服务聚合导航网站。
它不仅是一个静态的链接列表，更是一个**动态的监控平台**。它能实时检测目标网站的存活状态，支持用户互动（点赞、评论），并提供了一个安全隐蔽的后台管理系统，实现了从“硬编码”到“全数据库驱动”的架构升级。

---

## 2. 技术栈 (Tech Stack)

本项目采用了现代化的 Serverless 架构，追求极致的性能和低成本维护。

*   **运行环境**: [Cloudflare Pages](https://pages.cloudflare.com/) (托管静态资源与 Function)
*   **后端计算**: [Cloudflare Workers](https://workers.cloudflare.com/) (负责 SSR 渲染、API 逻辑、状态检测)
*   **数据库**: [Cloudflare D1](https://developers.cloudflare.com/d1/) (基于 SQLite 的边缘 Serverless 数据库)
*   **前端技术**:
    *   **HTML5/CSS3**: 纯原生实现，无庞大的前端框架（React/Vue），保证秒开速度。
    *   **JavaScript (ES6+)**: 处理轻量级交互（弹窗、AJAX 请求）。
    *   **Design**: 采用 **Glassmorphism (毛玻璃)** 设计风格，深色模式，视觉体验高端。

---

## 3. 核心功能模块

### A. 用户端 (Front Office)
1.  **SSR 服务端渲染**:
    *   首页 HTML 由后端动态生成，包含最新的点赞数、评论数和网站状态。
    *   **SEO 友好**，且解决了客户端渲染常见的“布局跳动”问题。
2.  **智能排序系统**:
    *   **优先级 1**: 状态（在线的网站永远排在维护中的网站前面）。
    *   **优先级 2**: 热度（点赞数多的排前面）。
    *   **优先级 3**: 收录时间（ID 顺序）。
3.  **实时状态监控**:
    *   后端定时（或按需）检测目标网站的连通性。
    *   显示“在线/维护中”状态标签，以及具体的延迟时间（如 `在线 200ms`）。
    *   **智能检测策略**: 仅检测“从未检测过”或“超过 6 小时未检测”的站点，节省资源。
4.  **用户互动系统**:
    *   **点赞**: 每日 IP 限流，防止刷票。
    *   **评论**: 支持昵称设置（本地持久化存储），支持“匿名访问”模式。
5.  **隐式邀请链接**:
    *   前端展示干净的域名（如 `example.com`），点击后自动跳转带参数的邀请链接（如 `example.com?aff=123`）。

### B. 管理端 (Back Office)
1.  **隐蔽入口**:
    *   后台地址为 `/Ganlian`（非标准 `/admin`），利用"隐身术"防御扫描。
2.  **安全鉴权 (Security)**:
    *   **环境变量密码**: 密码存储在 Cloudflare 环境变量 `ADMIN_PASSWORD` 中，代码中无硬编码。
    *   **内存级会话**: 登录状态仅保存在**内存变量**中，刷新页面或关闭标签页立即失效（阅后即焚模式）。
    *   **指数退避 (Exponential Backoff)**:
        *   基于数据库记录 IP 失败次数。
        *   惩罚机制：第 N 次错误强制等待 `2^(N-1)` 秒（1s, 2s, 4s, 8s...）。
        *   极大增加了暴力破解的时间成本。
3.  **可视化管理**:
    *   提供 Web 界面进行网站的 **增、删、改、查**。
    *   新增网站后，系统会**立即触发**状态检测，无需等待。

---

## 4. 数据库设计 (Schema)

基于 Cloudflare D1 (SQLite)，核心表结构如下：

### `websites` (核心表)
存储网站的基础信息和实时状态。
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | INTEGER | 主键，自增 |
| `name` | TEXT | 网站名称 |
| `description` | TEXT | 简短描述 |
| `invite_link` | TEXT | 实际跳转链接 (带邀请码) |
| `display_url` | TEXT | 前端展示链接 (用于显示和状态检测) |
| `status` | TEXT | 'online' 或 'offline' |
| `latency` | INTEGER | 延迟 (ms) |
| `last_checked` | DATETIME | 最后检测时间 |

### `likes` (点赞表)
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `card_id` | INTEGER | 关联 websites.id |
| `ip` | TEXT | 用户 IP (用于限流) |

### `comments` (评论表)
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `card_id` | INTEGER | 关联 websites.id |
| `nickname` | TEXT | 用户昵称 |
| `content` | TEXT | 评论内容 |

### `login_attempts` (安全表)
| 字段 | 类型 | 说明 |
| :--- | :--- | :--- |
| `ip` | TEXT | 来源 IP |
| `count` | INTEGER | 连续失败次数 |
| `last_attempt` | DATETIME | 最后尝试时间 |

---

## 5. 项目目录结构

```text
/
├── functions/              # Cloudflare Pages Functions (后端逻辑)
│   ├── api/                # API 接口
│   │   ├── admin/          # 管理员 API
│   │   │   └── websites.js # 网站增删改查接口
│   │   ├── comments.js     # 评论 API
│   │   ├── likes.js        # 点赞 API
│   │   ├── status.js       # 状态检测 API
│   │   └── submit.js       # (预留) 用户提交 API
│   ├── Ganlian.js          # 后台管理页面 (隐蔽入口)
│   └── index.js            # 首页 SSR 渲染逻辑 (核心入口)
├── index.html              # (已废弃) 旧的静态首页，现由 index.js 接管
├── style.css               # 首页样式表
├── admin.css               # 后台管理样式表
├── schema.sql              # 数据库初始化脚本
├── reset.sql               # 数据库重置脚本
├── wrangler.toml           # Cloudflare 配置文件 (定义数据库绑定等)
└── PROJECT_README.md       # 项目说明文档
```

## 6. 部署与维护

1.  **本地开发**:
    ```bash
    npx wrangler pages dev .
    ```
2.  **部署上线**:
    ```bash
    git push
    ```
    (Cloudflare Pages 会自动监听 GitHub 仓库变动并构建)
3.  **首次配置**:
    *   在 Cloudflare 后台绑定 D1 数据库 (变量名 `DB`)。
    *   设置环境变量 `ADMIN_PASSWORD`。
    *   执行 `schema.sql` 初始化数据库。
    
## 更新日志 (2025-12-05)

### ✨ 新增功能 (后台管理)
- **数据导入/导出**：
  - 全面支持 **JSON 格式**，比 CSV 更稳定，支持嵌套数据。
  - **智能导入**：导入时优先使用文件中的原始 ID，解决了“删除后重新导入 ID 暴涨”的问题。
  - **覆盖模式**：导入时可选择“覆盖现有数据”，根据 ID 自动更新或新增。
  - **导出兼容**：导出的“用户提交”数据结构已对齐，可直接导入到“主页网站”列表中。

### 🎨 界面与交互优化
- **视觉升级**：
  - **链接特效**：新增“霓虹辉光 + 能量条展开”的悬停动画，提升科技感。
  - **状态标签**：统一优化为双行居中显示（上方状态，下方延迟），样式更整洁。
- **评论体验**：
  - 评论图标旁新增 **评论计数** 显示。
  - 发布评论后 **实时更新** 计数，无需刷新页面。

### 🛡️ 安全与修复
- **接口安全**：废弃了旧的 URL 参数后门，导出接口迁移至 `/api/admin/export` 并强制验证管理员密码。
- **Bug 修复**：
  - 修复了后台删除网站时提示“删除失败”的问题（清理了废弃表的关联操作）。
  - 修复了导出数据可能出现的乱码问题（统一改为 JSON 格式）。

### 🛠️ 后台管理增强 (v2.0)
- **多标签管理**：新增 **“用户提交”** 标签页，可独立管理用户提交的网站申请。
- **批量操作**：
  - 支持 **批量删除** 网站或提交记录。
  - 支持 **批量通过**（将用户提交直接加入主页），并提供“覆盖现有数据”选项。
- **高级编辑**：
  - 支持直接 **修改网站 ID**（系统会自动级联更新关联的点赞和评论数据）。
  - 优化了导入/导出流程，支持更灵活的数据迁移。

### 📢 用户端体验优化
- **提交引导**：
  - 在首页顶部新增“欢迎分享”提示语，鼓励用户提交优质资源。
  - 优化提交弹窗文案，明确告知用户“审核通过后将展示您的邀请链接”，提高用户贡献积极性。
  - 优化提交弹窗文案，明确告知用户“审核通过后将展示您的邀请链接”，提高用户贡献积极性。
  - 优化输入框占位符提示，提升易用性。


### 🏗️ 代码重构
- **样式分离**：
  - 将内联 CSS 提取为独立的 `style.css` (前台) 和 `admin.css` (后台)。
  - 优化了项目结构，实现了关注点分离 (Separation of Concerns)，便于后续维护和浏览器缓存优化。

## 更新日志 (2025-12-15)

### 📰 新闻板块优化
- **UI 优化**：
  - 后台管理界面中，新闻列表不仅显示 ID，更直观地显示 **序号 (1, 2, 3...)**，解决了数据库自增 ID 不连续或过大导致的视觉混乱问题。
- **数据保留策略**：
  - 实现了 **安全的自动清理机制**。
  - 系统仅保留最新的 45 条新闻数据，自动删除旧新闻。
  - **重要修复**：回滚了之前可能误删网站关联数据（点赞/评论）的逻辑，确保新闻清理操作**仅针对** `news` 表，保障核心数据安全。

### 🗣️ 全栈用户反馈系统
- **数据库支持**：
  - 新增 `feedback` 表，用于存储用户建议、联系方式及状态。
- **前端交互**：
  - 在“提交网站”弹窗左下角新增 **虚线框反馈按钮**。
  - 点击后弹出独立的“意见反馈”对话框，支持输入内容和联系方式（可选）。
- **后台管理**：
  - 新增 **“用户反馈”** 标签页。
  - 管理员可查看所有用户提交的反馈建议（含 IP 和时间），并支持删除处理。

## 更新日志 (2025-12-22)

### 🌍 全球化支持 (i18n)
- **全站多语言**：
  - 核心页面 (`index.js`, `news.js`, `vpn.js`, `guide.js`) 全面实现了 **中/英** 双语支持。
  - 新增了 `functions/utils/i18n.js` 工具模块，集中管理所有 UI 文案，便于维护和扩展。
- **智能语言切换**：
  - **自动检测**：SSR 阶段自动解析请求头 (`Cookie` > `Accept-Language`)，智能匹配用户偏好语言。
  - **持久化存储**：用户手动切换语言后，通过 `Cookie` 记录偏好，确保跨页面和再次访问时语言状态保持一致。
- **无缝体验**：
  - 顶部导航栏新增了美观的“中 / En”切换按钮，实时响应。
  - 手动修复了大量硬编码的中文字符串，确保在英文模式下无“漏网之鱼”。
  - 特别针对 `guide.js` 中的技术文档、代码块注释、以及 Windows/macOS/Linux 的详细配置步骤进行了深度本地化。

### 🔧 工程化改进
- **构建优化**：
  - 解决了 `template literal` 中特殊字符转义导致的构建失败问题，确保 Cloudflare Pages 能顺利部署。
- **代码规范**：
  - 统一了文件编码和 API 调用规范，提升了项目的可维护性。


## 更新日志 (2025-12-26)

### 📸 新增板块：AI 摄影师 (AI Photos)
- **核心功能上线**：
  - 新增 `/photos` 页面，采用与主站一致的 **Glassmorphism (毛玻璃)** 设计风格。
  - 实现了 **“智能提示词构建器” (Smart Prompt Builder)**，用户可自由组合“主角”与“风格套餐” (如赛博朋克、宫崎骏风)。
  - 支持 **“图生图” (Img2Img)** 功能：用户可上传或拖拽参考图片，搭配提示词进行生成。
- **技术实现**：
  - **前端 (SSR)**：新建 `functions/photos.js`，包含完整的交互逻辑（拖拽上传、Base64 转换、实时预览）。
  - **后端 (API)**：新建 `functions/api/generate.js` 作为安全代理，预留了对接 Nano Banana (Google Gemini) API 的能力。
  - **样式**：在 `style.css` 中新增了上传区域、加载动画及卡片选中态的样式支持。
